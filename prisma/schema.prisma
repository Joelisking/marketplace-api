generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-arm64-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                   String              @id @default(cuid())
  email                String              @unique
  password             String
  role                 Role
  storeId              String?             @unique
  createdAt            DateTime            @default(now())
  firstName            String?
  lastName             String?
  phone                String?
  updatedAt            DateTime?
  emailVerified        Boolean             @default(false)
  phoneVerified        Boolean             @default(false)
  emailVerifiedAt      DateTime?
  phoneVerifiedAt      DateTime?
  address              Address?
  cartItems            CartItem[]
  notifications        Notification[]      @relation("UserNotifications")
  orders               Order[]
  store                Store?              @relation("VendorStore", fields: [storeId], references: [id])
  reviewedApplications VendorApplication[] @relation("VendorApplicationReviewer")
  vendorApplication    VendorApplication?  @relation("VendorApplication")
  verifiedDocuments    VendorDocument[]    @relation("DocumentVerifier")
  vendorPayouts        VendorPayout[]      @relation("VendorPayouts")
  buyerConversations   Conversation[]      @relation("BuyerConversations")
  sellerConversations  Conversation[]      @relation("SellerConversations")
  messages             Message[]
  productReviews       ProductReview[]
  wishlists            Wishlist[]
  openedDisputes       OrderDispute[]      @relation("DisputeOpener")
  resolvedDisputes     OrderDispute[]      @relation("DisputeResolver")

  @@index([email])
  @@index([role])
  @@index([emailVerified])
  @@index([phoneVerified])
}

model Address {
  id         String   @id @default(cuid())
  userId     String   @unique
  street     String
  city       String
  state      String
  postalCode String
  country    String   @default("Nigeria")
  isDefault  Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Store {
  id                    String         @id @default(cuid())
  name                  String
  slug                  String         @unique
  logoUrl               String?
  createdAt             DateTime       @default(now())
  description           String?
  isActive              Boolean        @default(true)
  updatedAt             DateTime?
  paystackAccountActive Boolean        @default(false)
  paystackAccountCode   String?
  vendorId              String?
  ghanaCardFrontUrl     String?
  ghanaCardBackUrl      String?
  ghanaCardUploadedAt   DateTime?
  orders                Order[]
  products              Product[]
  owner                 User?          @relation("VendorStore")
  vendorPayouts         VendorPayout[] @relation("StorePayouts")

  @@index([slug])
  @@index([isActive])
  @@index([vendorId])
  @@index([paystackAccountCode])
}

model Product {
  id                String          @id @default(cuid())
  storeId           String
  name              String
  price             Int
  stock             Int
  imageUrl          String
  visibleMarket     Boolean         @default(true)
  createdAt         DateTime        @default(now())
  description       String?
  dimensions        Json?
  isActive          Boolean         @default(true)
  sku               String?
  updatedAt         DateTime?
  weight            Float?
  category          String?
  trackInventory    Boolean         @default(true)
  lowStockThreshold Int             @default(10)
  allowBackorder    Boolean         @default(false)
  reviewCount       Int             @default(0)
  averageRating     Float           @default(0)
  cartItems         CartItem[]
  orderItems        OrderItem[]
  store             Store           @relation(fields: [storeId], references: [id])
  images            ProductImage[]
  reviews           ProductReview[]
  wishlists         Wishlist[]
  conversations     Conversation[]

  @@index([storeId, name])
  @@index([storeId, isActive])
  @@index([sku])
  @@index([visibleMarket, isActive])
  @@index([category])
  @@index([stock, lowStockThreshold])
}

model ProductImage {
  id        String   @id @default(cuid())
  productId String
  fileName  String
  fileUrl   String
  altText   String?
  isPrimary Boolean  @default(false)
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId, isPrimary])
  @@index([productId, sortOrder])
}

model CartItem {
  id        String    @id @default(cuid())
  userId    String
  productId String
  quantity  Int
  createdAt DateTime  @default(now())
  updatedAt DateTime?
  product   Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, productId])
  @@index([userId])
  @@index([productId])
}

model Order {
  id                   String           @id @default(cuid())
  customerId           String
  storeId              String
  status               OrderStatus
  paymentStatus        PaymentStatus
  total                Int
  createdAt            DateTime         @default(now())
  updatedAt            DateTime?
  billingAddress       Json?
  cancelReason         String?
  cancelledAt          DateTime?
  currency             String           @default("GHS")
  deliveredAt          DateTime?
  discount             Int              @default(0)
  estimatedDelivery    DateTime?
  notes                String?
  paymentData          Json?
  paymentProvider      String?
  paymentReference     String?
  shipping             Int              @default(0)
  shippingAddress      Json?
  deliveryZone         String?
  subtotal             Int
  tax                  Int              @default(0)
  deliveryStatus       DeliveryStatus   @default(PENDING)
  deliveryConfirmedAt  DateTime?
  deliveryConfirmedBy  String?
  disputeStatus        DisputeStatus    @default(NONE)
  disputeReason        String?
  disputeOpenedAt      DateTime?
  autoReleaseDate      DateTime?
  settlementStatus     SettlementStatus @default(HELD)
  customer             User             @relation(fields: [customerId], references: [id])
  store                Store            @relation(fields: [storeId], references: [id])
  orderEvents          OrderEvent[]
  items                OrderItem[]
  payments             Payment[]
  vendorPayouts        VendorPayout[]   @relation("OrderPayouts")
  conversations        Conversation[]
  reviews              ProductReview[]
  disputes             OrderDispute[]

  @@index([customerId, createdAt])
  @@index([storeId, createdAt])
  @@index([status])
  @@index([paymentStatus])
  @@index([paymentReference])
  @@index([createdAt])
  @@index([deliveryStatus])
  @@index([disputeStatus])
  @@index([settlementStatus])
  @@index([autoReleaseDate])
}

model OrderItem {
  id        String  @id @default(cuid())
  orderId   String
  productId String
  quantity  Int
  price     Int
  total     Int
  order     Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product   Product @relation(fields: [productId], references: [id])

  @@index([orderId])
  @@index([productId])
}

model Payment {
  id           String        @id @default(cuid())
  orderId      String
  amount       Int
  currency     String        @default("NGN")
  provider     String
  reference    String
  status       PaymentStatus
  providerData Json?
  metadata     Json?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime?
  order        Order         @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([reference])
  @@index([status])
  @@index([createdAt])
}

model OrderEvent {
  id          String         @id @default(cuid())
  orderId     String
  eventType   OrderEventType
  description String
  metadata    Json?
  createdAt   DateTime       @default(now())
  order       Order          @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId, createdAt])
  @@index([eventType])
}

model InventoryLog {
  id            String           @id @default(cuid())
  productId     String
  type          InventoryLogType
  quantity      Int
  previousStock Int
  newStock      Int
  reason        String?
  reference     String?
  metadata      Json?
  createdAt     DateTime         @default(now())

  @@index([productId, createdAt])
  @@index([type])
}

model VendorPayout {
  id                  String       @id @default(cuid())
  vendorId            String
  storeId             String
  orderId             String
  amount              Int
  platformFee         Int
  totalAmount         Int
  status              PayoutStatus
  paystackAccountCode String
  metadata            Json?
  processedAt         DateTime?
  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @updatedAt
  settlementDate      DateTime?
  autoReleased        Boolean      @default(false)
  escrowReleaseDate   DateTime?
  heldUntil           DateTime?
  order               Order        @relation("OrderPayouts", fields: [orderId], references: [id])
  store               Store        @relation("StorePayouts", fields: [storeId], references: [id])
  vendor              User         @relation("VendorPayouts", fields: [vendorId], references: [id])

  @@index([vendorId, createdAt])
  @@index([storeId, createdAt])
  @@index([orderId])
  @@index([paystackAccountCode])
  @@index([escrowReleaseDate])
  @@index([status, heldUntil])
}

model Notification {
  id           String    @id @default(cuid())
  userId       String
  type         String
  title        String
  message      String
  channels     String[]
  priority     String
  metadata     Json?
  isRead       Boolean   @default(false)
  scheduledFor DateTime?
  sentAt       DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  user         User      @relation("UserNotifications", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([userId, isRead])
  @@index([type])
  @@index([priority])
}

model VendorApplication {
  id                   String                  @id @default(cuid())
  userId               String                  @unique
  businessName         String
  businessType         BusinessType
  businessDescription  String
  businessAddress      String
  businessPhone        String
  taxIdentification    String?
  bankName             String
  bankAccountNumber    String
  bankAccountName      String
  bankCode             String
  commissionRate       Float                   @default(5.0)
  expectedMonthlySales ExpectedSalesVolume
  productCategories    String[]
  socialMediaLinks     Json?
  status               VendorApplicationStatus @default(PENDING)
  reviewNotes          String?
  reviewedBy           String?
  reviewedAt           DateTime?
  approvedAt           DateTime?
  rejectedAt           DateTime?
  rejectionReason      String?
  createdAt            DateTime                @default(now())
  updatedAt            DateTime                @updatedAt
  ghanaCardNumber      String?
  reviewer             User?                   @relation("VendorApplicationReviewer", fields: [reviewedBy], references: [id])
  user                 User                    @relation("VendorApplication", fields: [userId], references: [id], onDelete: Cascade)
  businessDocuments    VendorDocument[]

  @@index([userId])
  @@index([status])
  @@index([businessType])
  @@index([createdAt])
}

model VendorDocument {
  id                String             @id @default(cuid())
  applicationId     String
  documentType      VendorDocumentType
  fileName          String
  fileUrl           String
  fileSize          Int
  mimeType          String
  isVerified        Boolean            @default(false)
  verificationNotes String?
  uploadedAt        DateTime           @default(now())
  verifiedAt        DateTime?
  verifiedBy        String?
  side              GhanaCardSide?
  application       VendorApplication  @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  verifier          User?              @relation("DocumentVerifier", fields: [verifiedBy], references: [id])

  @@index([applicationId])
  @@index([documentType])
  @@index([isVerified])
  @@index([side])
}

enum Role {
  CUSTOMER
  VENDOR
  ADMIN
  SUPER
}

enum PaymentStatus {
  UNPAID
  PAID
  PENDING
  FAILED
  REFUNDED
  CANCELLED
}

enum OrderStatus {
  PENDING
  PROCESSING
  SHIPPED
  DELIVERED
  CONFIRMED
  CANCELLED
  REFUNDED
}

enum OrderEventType {
  ORDER_CREATED
  PAYMENT_RECEIVED
  ORDER_CONFIRMED
  ORDER_PROCESSING
  ORDER_SHIPPED
  ORDER_DELIVERED
  ORDER_CANCELLED
  PAYMENT_FAILED
  PAYMENT_REFUNDED
  VENDOR_PAYOUTS_PROCESSED
  ORDER_DELIVERED_CONFIRMED
  DISPUTE_OPENED
  DISPUTE_RESOLVED
  FUNDS_RELEASED
}

enum InventoryLogType {
  STOCK_IN
  STOCK_OUT
  ADJUSTMENT
  RESERVED
  RELEASED
}

enum PayoutStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

enum BusinessType {
  INDIVIDUAL
  SOLE_PROPRIETORSHIP
  PARTNERSHIP
  LIMITED_LIABILITY_COMPANY
  CORPORATION
  COOPERATIVE
  OTHER
}

enum ExpectedSalesVolume {
  UNDER_1000
  ONE_TO_FIVE_THOUSAND
  FIVE_TO_TEN_THOUSAND
  TEN_TO_FIFTY_THOUSAND
  FIFTY_TO_HUNDRED_THOUSAND
  OVER_HUNDRED_THOUSAND
}

enum VendorApplicationStatus {
  PENDING
  UNDER_REVIEW
  DOCUMENTS_REQUESTED
  APPROVED
  REJECTED
  SUSPENDED
}

enum VendorDocumentType {
  BUSINESS_LICENSE
  TAX_CLEARANCE
  BANK_STATEMENT
  IDENTITY_DOCUMENT
  UTILITY_BILL
  LEASE_AGREEMENT
  INSURANCE_CERTIFICATE
  OTHER
  GHANA_CARD
}

enum GhanaCardSide {
  FRONT
  BACK
}

enum OtpType {
  EMAIL
  PHONE
}

enum OtpPurpose {
  REGISTRATION
  PHONE_VERIFICATION
  PASSWORD_RESET
  TRANSACTION
}

enum ConversationStatus {
  ACTIVE
  ARCHIVED
  BLOCKED
}

enum DeliveryStatus {
  PENDING
  CONFIRMED
  DISPUTED
  AUTO_CONFIRMED
}

enum DisputeStatus {
  NONE
  OPEN
  IN_REVIEW
  RESOLVED
  REFUNDED
}

enum SettlementStatus {
  HELD
  RELEASED
  PENDING_RELEASE
  CANCELLED
}

model OtpVerification {
  id          String     @id @default(cuid())
  userId      String?
  type        OtpType
  purpose     OtpPurpose
  recipient   String
  code        String
  expiresAt   DateTime
  verifiedAt  DateTime?
  attempts    Int        @default(0)
  maxAttempts Int        @default(3)
  isUsed      Boolean    @default(false)
  metadata    Json?
  createdAt   DateTime   @default(now())

  @@index([recipient, type])
  @@index([userId])
  @@index([expiresAt])
}

model Conversation {
  id            String             @id @default(cuid())
  buyerId       String
  sellerId      String
  productId     String?
  orderId       String?
  status        ConversationStatus @default(ACTIVE)
  lastMessageAt DateTime?
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  buyer         User               @relation("BuyerConversations", fields: [buyerId], references: [id], onDelete: Cascade)
  seller        User               @relation("SellerConversations", fields: [sellerId], references: [id], onDelete: Cascade)
  product       Product?           @relation(fields: [productId], references: [id], onDelete: SetNull)
  order         Order?             @relation(fields: [orderId], references: [id], onDelete: SetNull)
  messages      Message[]

  @@index([buyerId])
  @@index([sellerId])
  @@index([productId])
  @@index([status])
  @@index([lastMessageAt])
}

model Message {
  id             String       @id @default(cuid())
  conversationId String
  senderId       String
  content        String
  isRead         Boolean      @default(false)
  readAt         DateTime?
  attachments    Json?
  createdAt      DateTime     @default(now())
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender         User         @relation(fields: [senderId], references: [id], onDelete: Cascade)

  @@index([conversationId, createdAt])
  @@index([senderId])
  @@index([isRead])
}

model OrderDispute {
  id           String        @id @default(cuid())
  orderId      String
  openedBy     String
  reason       String
  description  String?
  status       DisputeStatus @default(OPEN)
  resolution   String?
  resolvedBy   String?
  resolvedAt   DateTime?
  refundAmount Int?
  evidence     Json?
  adminNotes   String?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  order        Order         @relation(fields: [orderId], references: [id], onDelete: Cascade)
  opener       User          @relation("DisputeOpener", fields: [openedBy], references: [id], onDelete: Cascade)
  resolver     User?         @relation("DisputeResolver", fields: [resolvedBy], references: [id])

  @@index([orderId])
  @@index([status])
  @@index([openedBy])
}

model ProductReview {
  id          String   @id @default(cuid())
  productId   String
  orderId     String
  userId      String
  rating      Int
  title       String?
  review      String?
  pros        String[]
  cons        String[]
  verified    Boolean  @default(false)
  helpful     Int      @default(0)
  notHelpful  Int      @default(0)
  response    String?
  respondedAt DateTime?
  isPublished Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  order       Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([orderId, productId, userId])
  @@index([productId, rating])
  @@index([userId])
  @@index([createdAt])
}

model Wishlist {
  id        String   @id @default(cuid())
  userId    String
  productId String
  notes     String?
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([userId, productId])
  @@index([userId, createdAt])
}
